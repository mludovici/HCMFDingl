/*
 * Copyright (C) 2009-2021 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/base/Object","sap/ui/model/Filter","sap/ui/model/FilterOperator","hcm/fab/lib/common/util/DateUtil"],function(u,F,a,D){"use strict";var M=6;var b=8;var S=["EmployeeID","RequestID","ChangeStateID","LeaveKey","StatusID","StatusTxt","AbsenceTypeCode","AbsenceTypeName","StartDate","StartTime","EndDate","EndTime","PlannedWorkingHours","PlannedWorkingDays","CalendarDays","PayrollDays","TimeUnitTxt","IsDeletable","IsModifiable","QuotaUsed","ApproverEmployeeID","ApproverEmployeeName","FirstSubmissionDate","FirstSubmissionTime","AttachmentsExist","ReqOrInfty"];var c=["EmployeeID","RequestID","ChangeStateID","LeaveKey","StatusID","StatusTxt","AbsenceTypeCode","AbsenceTypeName","StartDate","StartTime","EndDate","EndTime","Notes","PlannedWorkingHours","PlannedWorkingDays","CalendarDays","PayrollDays","TimeUnitTxt","IsDeletable","IsModifiable","QuotaUsed","ApproverEmployeeID","ApproverEmployeeName","IsMultiLevelApproval","LeaveRequestType","FirstSubmissionDate","FirstSubmissionTime","AttachmentsExist","AdditionalFields","ApproverLvl1","ApproverLvl2","ApproverLvl3","ApproverLvl4","ApproverLvl5","Attachment1","Attachment2","Attachment3","Attachment4","Attachment5","ActionID"];var _;var d=u.extend("hcm.fab.myleaverequest.utils.DataUtil",{constructor:function(e,m){var o=m.getMetaModel(),E=o.getODataEntitySet("LeaveRequestSet"),p=o.getODataEntityType(E.entityType).property,C=[];if(p.some(function(P){return P.name==="ReqOrInfty";}.bind(this))){c.push("ReqOrInfty");p.forEach(function(P){if(c.indexOf(P.name)===-1){C.push(P.name);}});this._sLeaveOverviewSelectParams=this._buildSelectParams(S.concat(C));}else{this._sLeaveOverviewSelectParams=this._buildSelectParams(c);}this._sEmployeeId=e;this._oModel=m;this._oPendingRequest=undefined;this._oBufferUtil.refresh();},_buildSelectParams:function(p){return p.join();},refresh:function(){this._oBufferUtil.refresh();},getCalendarEvents:function(s,e){if(this._oPendingRequest){return this._oPendingRequest.then(function(){return this.getCalendarEvents(s,e);}.bind(this));}var o=s,E=e;if(!e){var t=new Date();o=new Date(t.getFullYear(),0,1);if(t.getMonth()<b){E=new Date(t.getFullYear(),11,31);}else{E=this._calculateMinimumEndDate(t);}}this._oPendingRequest=Promise.all([this._readLeaveRequest(s),this._readWorkSchedule(o,E)]).then(function(){this._oPendingRequest=undefined;return this._oBufferUtil.getDataFromBuffer(s,e);}.bind(this));return this._oPendingRequest;},_readLeaveRequest:function(s){var l=this._oBufferUtil.getLeaveRequestReadDate();if(l&&l<=s){return Promise.resolve();}var f=[new F("StartDate",a.GE,D.convertToUTC(s)),new F("EmployeeID",a.EQ,this._sEmployeeId)];return new Promise(function(r,e){this._oModel.read("/LeaveRequestSet",{filters:f,groupId:"leaveRequests",urlParameters:{"$select":this._sLeaveOverviewSelectParams},success:function(o){this._oBufferUtil.addLeaveRequestData(s,o.results);r();}.bind(this),error:function(){e();}});}.bind(this));},_readWorkSchedule:function(s,e){var f=new Date(s.getFullYear(),s.getMonth());var g=new Date(e.getFullYear(),e.getMonth()+1,0);while(this._oBufferUtil.isDateInBuffer(f)&&f<g){f.setMonth(f.getMonth()+1);}while(this._oBufferUtil.isDateInBuffer(g)&&f<g){g.setMonth(g.getMonth()-1);}if(f>g){return Promise.resolve();}var h=this._calculateMinimumEndDate(s);if(h>g){g=h;g.setDate(1);while(this._oBufferUtil.isDateInBuffer(g)&&f<g){g.setMonth(g.getMonth()-1);}g.setMonth(g.getMonth()+1);g.setDate(g.getDate()-1);}var i=[new F("EmployeeNumber",a.EQ,this._sEmployeeId),new F("StartDate",a.BT,D.convertToUTC(f),D.convertToUTC(g))];return new Promise(function(r,j){this._oModel.read("/EmployeeCalendarSet",{filters:i,groupId:"leaveRequests",success:function(o){this._oBufferUtil.addWorkScheduleData(f,g,o.results);r();}.bind(this),error:function(){j();}});}.bind(this));},_calculateMinimumEndDate:function(s){if(s.getMonth()%2===0){return new Date(s.getFullYear(),s.getMonth()+M,0);}else{return new Date(s.getFullYear(),s.getMonth()+M-1,0);}},_oBufferUtil:{_oBuffer:{},refresh:function(){this._oBuffer={oMonths:{},aLeaveRequestData:[],oLeaveRequestReadDate:undefined};},getLeaveRequestReadDate:function(){return this._oBuffer.oLeaveRequestReadDate;},convertLocalDateToBufferKey:function(o){return o.getFullYear()+"/"+("00"+(o.getMonth()+1)).slice(-2);},isDateInBuffer:function(o){var k=this.convertLocalDateToBufferKey(o);return this._oBuffer.oMonths[k]!==undefined;},addDateToBuffer:function(o){var k=this.convertLocalDateToBufferKey(o);this._oBuffer.oMonths[k]={aWorkSchedule:[]};},addLeaveRequestData:function(s,l){var L=[];l.forEach(function(o){L.push(o);});this._oBuffer.aLeaveRequestData=L;this._oBuffer.oLeaveRequestReadDate=s;},addWorkScheduleData:function(s,e,w){var f=new Date(s.getTime());while(f<=e){this.addDateToBuffer(f);f.setMonth(f.getMonth()+1);}w.forEach(function(W){var k=this.convertLocalDateToBufferKey(D.convertToLocal(W.StartDate));var B=this._oBuffer.oMonths[k];if(!B){this.addDateToBuffer(W.StartDate);B=this._oBuffer.oMonths[k];}this._oBuffer.oMonths[k].aWorkSchedule.push(W);}.bind(this));},getLeaveRequestFromBuffer:function(s,e){var r=[];for(var i=0;i<this._oBuffer.aLeaveRequestData.length;i++){var l=this._oBuffer.aLeaveRequestData[i];var L=D.convertToLocal(l.StartDate);var o=D.convertToLocal(l.EndDate);if(o<s||(e&&L>e)){continue;}r.push(l);}return r;},getWorkScheduleFromBuffer:function(s,e){var r=[];var f=new Date(s.getFullYear(),s.getMonth());while(f<e){var k=this.convertLocalDateToBufferKey(f);var B=this._oBuffer.oMonths[k];if(B){var w=B.aWorkSchedule;for(var i=0;i<w.length;i++){var o=w[i];var g=D.convertToLocal(o.StartDate);if(g<s||g>e){continue;}r.push(o);}}f.setMonth(f.getMonth()+1);}return r;},getDataFromBuffer:function(s,e){return{leaveRequests:this.getLeaveRequestFromBuffer(s),workSchedule:this.getWorkScheduleFromBuffer(s,e)};}}});d.getInstance=function(e,m){if(!_||_._sEmployeeId!==e||_._oModel!==m){_=new d(e,m);}return _;};return d;});
