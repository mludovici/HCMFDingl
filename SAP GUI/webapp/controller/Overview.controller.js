/*
 * Copyright (C) 2009-2021 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["hcm/fab/myleaverequest/utils/utils","hcm/fab/myleaverequest/utils/formatters","hcm/fab/myleaverequest/utils/CalendarUtil","hcm/fab/myleaverequest/utils/DataUtil","hcm/fab/lib/common/util/DateUtil","sap/ui/Device","hcm/fab/myleaverequest/controller/BaseController","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/routing/History","sap/ui/core/format/DateFormat","sap/ui/unified/DateRange","sap/ui/unified/DateTypeRange","sap/ui/unified/CalendarLegendItem","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/m/MessageToast","sap/m/MessagePopover","sap/m/MessagePopoverItem","sap/m/SegmentedButton","sap/m/Dialog","jquery.sap.storage"],function(u,f,C,D,a,b,B,F,c,H,d,e,g,h,J,M,i,j,k,S,l,q){"use strict";return B.extend("hcm.fab.myleaverequest.controller.Overview",{CALENDARPERSKEY:"showCalendar",ENTITLEMENTSPERSKEY:"expandEntitlements",OVERVIEWPERSKEY:"expandOverview",oStorage:jQuery.sap.storage(jQuery.sap.storage.Type.local),formatter:f,DateUtil:a,extHookAdjustOverviewCalendar:null,onInit:function(){var s=this.oStorage.get(this.CALENDARPERSKEY)!==null?this.oStorage.get(this.CALENDARPERSKEY):false;this._oOverviewModel=new J({showCalendar:s,viewSelection:s?"calendar":"list",entCount:0,overviewCount:0,overviewCountText:this.getResourceBundle().getText("items",["0"]),entitlementsExpanded:this.oStorage.get(this.ENTITLEMENTSPERSKEY)!==null?this.oStorage.get(this.ENTITLEMENTSPERSKEY):true,overviewExpanded:this.oStorage.get(this.OVERVIEWPERSKEY)!==null?this.oStorage.get(this.OVERVIEWPERSKEY):true,calendarBusy:false,isLeaveLoading:false,isDeletingLeaveRequest:false,entitlementStartDate:new Date(),nonWorkingDays:null,leaveRequestStartDate:null,showMinDisplayStrip:false,leaveRequestTableItems:[]});this.setModel(this._oOverviewModel,"overview");this._oCalLegendItemPubHol=null;this._sEmployeeNumber=null;this.oComponent=this.getOwnerComponent();this.oODataModel=this.oComponent.getModel();this.oErrorHandler=this.oComponent.getErrorHandler();this._toggleCalendarModel(this._oOverviewModel.getProperty("/showCalendar"));this._toggleEntitlements(this._oOverviewModel.getProperty("/entitlementsExpanded"));this._toggleOverview(this._oOverviewModel.getProperty("/overviewExpanded"));this.getRouter().getRoute("overview").attachPatternMatched(this._onRouteMatched,this);this.oComponent.getEventBus().subscribe("hcm.fab.myleaverequest","invalidateoverview",this.onInvalidateOverview,this);var o=this.getView().byId("calendar");C.configureCalendar(o,this.oODataModel,this.getResourceBundle());if(b.system.desktop){this.byId("overviewOnBehalfIndicator").addStyleClass("sapUiResponsiveMargin");this.byId("quotaUsedColTxt").addStyleClass("sapUiLargeMarginEnd");this.byId("quotaUsedCell").addStyleClass("sapMTableContentMargin sapUiLargeMarginEnd");}else if(b.system.tablet){this.byId("overviewOnBehalfIndicator").addStyleClass("sapUiResponsiveMargin");}else{this.byId("overviewOnBehalfIndicator").addStyleClass("sapUiSmallMargin");this.byId("quotaUsedCell").addStyleClass("sapMTableContentMargin");}if(S.getMetadata().getEvent("selectionChange")){this.byId("calendarToggleButton").attachEvent("selectionChange",this.onSelect.bind(this));}else{this.byId("calendarToggleButton").attachEvent("select",this.onSelect.bind(this));}if(this.extHookAdjustOverviewCalendar){this.extHookAdjustOverviewCalendar(o);}},onExit:function(){this.oErrorHandler.clearErrors();if(this._oQuickView){this._oQuickView.destroy();this._oQuickView=undefined;}},onInvalidateOverview:function(s,E,o){this.getModel("global").setProperty("/lastLeaveRequestChangeDate",new Date());if(o.fnAfterNavigate){o.fnAfterNavigate();}this._oDataUtil.refresh();this._refreshAbsences();this._refreshEntitlements();},onAssignmentSwitch:function(E){var A=this.getOwnerComponent().getAssignmentPromise(E.getParameter("selectedAssignment"));A.then(function(s){this._initOverviewModelBinding(s);}.bind(this));},onEntitlementDateChanged:function(E){var n=d.getDateInstance().parse(E.getParameter("newValue")),v=E.getParameter("valid"),o=E.getSource(),m=this.getView().byId("entitlementTable").getBinding("items");this._oOverviewModel.setProperty("/entitlementStartDate",n);if(n&&v){o.setValueState(sap.ui.core.ValueState.None);m.filter([new F("FilterStartDate",c.GE,u.dateToUTC(n)),new F("EmployeeID",c.EQ,this.getModel("global").getProperty("/sEmployeeNumber"))],"Application");}else{o.setValueState(sap.ui.core.ValueState.Error);}},onUpdateFinishedEntitlements:function(E){this._oOverviewModel.setProperty("/entCount",E.getParameter("total"));},onUpdateFinishedOverview:function(E){this._oOverviewModel.setProperty("/overviewCount",E.getParameter("total"));this._oOverviewModel.setProperty("/overviewCountText",this.getResourceBundle().getText("items",[E.getParameter("total")]));},onCreateLeave:function(){var o=this.getView().byId("calendar"),s=o.getSelectedDates(),r=this.getRouter();if(s.length===0){r.navTo("creation");}else{var m=s[0],n=u.dateToUTC(m.getStartDate());o.destroySelectedDates();r.navTo("creationWithParams",{dateFrom:""+n.getTime(),dateTo:""+n.getTime(),absenceType:"default",sEmployeeID:this.getModel("global").getProperty("/sEmployeeNumber")});}},onClose:function(){this.oDialog.close();},onItemPressed:function(E){var o=E.getParameter("listItem").getBindingContext("overview");var L=o.getModel().getProperty(o.getPath());var p=this.getModel().createKey("/LeaveRequestSet",L).substr(1);this.getRouter().navTo("display",{leavePath:p});},onEntitlementItemPressed:function(E){var o=E.getParameter("listItem").getBindingContext();if(!this._oQuickView){this._oQuickView=sap.ui.xmlfragment("hcm.fab.myleaverequest.view.fragments.EntitlementDetail",this);this.getView().addDependent(this._oQuickView);}this._oQuickView.setBindingContext(o);this._oQuickView.openBy(E.getSource());},onHandlePopover:function(E){var m=E.getSource(),v=this.getView();if(!this._oMessagePopover){this._oMessagePopover=new j({items:{path:"message>/",template:new k({type:"{message>type}",title:"{message>message}",subtitle:"{message>additionalText}",description:"{message>code}"})}});jQuery.sap.syncStyleClass(this.getOwnerComponent().getContentDensityClass(),v,this._oMessagePopover);v.addDependent(this._oMessagePopover);}this._oMessagePopover.toggle(m);},onNavBack:function(){this.oErrorHandler.clearErrors();var p=H.getInstance().getPreviousHash(),o=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");if(p!==undefined||(o&&!o.isInitialNavigation())){if(o){o.historyBack();}else{window.history.go(-1);}}else{o.toExternal({target:{shellHash:o.hrefForExternal({target:{shellHash:"#"}})}});}},onDeleteSwipe:function(E){this._deleteRequest(E.getSource().getParent().getSwipedItem());},onDeletePress:function(E){var L=E.getSource(),I=E.getSource().getParent(),o=this.getOwnerComponent(),m=I.getBindingContext("overview").getObject(),p=this.getModel().createKey("/LeaveRequestSet",m).substr(1),n=false;if(this.getModel("global").getProperty("/bEditRequestBeforeDeletion")){if(m.hasOwnProperty("ReqOrInfty")){n=m.ReqOrInfty==='A'||m.ReqOrInfty==='P';}else{n=m.StatusID==="POSTED"||m.ChangeStateID===0;}}if(n){this.getRouter().navTo("delete",{leavePath:p});}else{M.confirm(this.getResourceBundle().getText("confirmDeleteMessage"),{styleClass:o.getContentDensityClass(),initialFocus:M.Action.CANCEL,onClose:function(A){if(A===M.Action.OK){L.attachEventOnce("updateFinished",L.focus,L);this._deleteRequest(I);}}.bind(this)});}},onEditPress:function(E){var o=E.getSource().getBindingContext("overview");var L=o.getModel().getProperty(o.getPath());var p=this.getModel().createKey("/LeaveRequestSet",L).substr(1);this.getRouter().navTo("edit",{leavePath:p});},onLeaveOverviewDateChanged:function(E){var o=d.getDateInstance({UTC:true}),n=o.parse(E.getParameter("newValue")),O=E.getSource();if(n){var m=this.getModel("global").getProperty("/leaveRequestMinDisplayDate");if(n.getTime()<m.getTime()){O.setValueState(sap.ui.core.ValueState.Warning);O.setValueStateText(this.getResourceBundle().getText("minDisplayDateTxt",[o.format(m)]));n=m;this._oOverviewModel.setProperty("/showMinDisplayStrip",true);}else{O.setValueState(sap.ui.core.ValueState.None);O.setValueStateText(null);this._oOverviewModel.setProperty("/showMinDisplayStrip",false);}this._oOverviewModel.setProperty("/leaveRequestStartDate",n);var p=this.getView().byId("calendar");p.focusDate(n);this._bindLeaveRequestList(n);}else{O.setValueState(sap.ui.core.ValueState.Error);}},onCloseMinDispMessStrip:function(){var o=this.getView().byId("overviewDatePicker");o.setValueState(sap.ui.core.ValueState.None);o.setValueStateText(null);},onCalendarDateSelect:function(E){var o=E.getSource(),r=this.getRouter(),s=o.getSelectedDates()[0],m=a.convertToUTC(s.getStartDate()),n=a.convertToUTC(s.getEndDate());if(n){o.destroySelectedDates();r.navTo("creationWithParams",{dateFrom:""+m.getTime(),dateTo:""+n.getTime(),absenceType:"default",sEmployeeID:this.getModel("global").getProperty("/sEmployeeNumber")});}else{var p=null,t=null,v=o.getSpecialDates().filter(function(y){p=a.convertToUTC(y.getStartDate());t=a.convertToUTC(y.getEndDate());return p<=m&&t>=m&&y.getType()!==sap.ui.unified.CalendarDayType.Type09;});if(v.length>0){o.destroySelectedDates();if(v.length===1){r.navTo("display",{leavePath:v[0].data("path")});}else{var L=[],w={},O=this.getModel();v.forEach(function(y){w=O.getObject("/"+y.data("path"));w.sLeavePath=y.data("path");L.push(w);});if(!this._multiLeaveDialog){this._multiLeaveDialog=u.setResizableDraggableForDialog(sap.ui.xmlfragment("hcm.fab.myleaverequest.view.fragments.MultiLeaveSelectDialog",this));var x=this._multiLeaveDialog.getBindingInfo("items").template.getFirstStatus();if(x&&x.getMetadata().hasProperty("inverted")){x.setInverted(true);}if(this._multiLeaveDialog._oDialog){this._multiLeaveDialog._oDialog.getSubHeader().setVisible(false);}this._multiLeaveDialog.setModel(new J(),"multiLeave");this.getView().addDependent(this._multiLeaveDialog);}this._multiLeaveDialog.getModel("multiLeave").setData({aLeaves:L});this._multiLeaveDialog.open();}}}},onCalendarStartDateChange:function(){if(!this._oDataUtil){return;}var o=this.getView().byId("calendar"),s=o.getStartDate(),E=new Date(s.getFullYear(),s.getMonth()+o.getMonths(),0),m=this._oOverviewModel.getProperty("/leaveRequestStartDate");if(s<m){s=m;}o.removeAllSpecialDates();this._oOverviewModel.setProperty("/calendarBusy",true);this._oDataUtil.getCalendarEvents(s,E).then(function(r){this._oOverviewModel.setProperty("/calendarBusy",false);C.fillCalendarWithLeaves(o,r.leaveRequests,s,E);C.fillCalendarFromEmployeeCalendar(o,r.workSchedule);jQuery.sap.delayedCall(0,o,o.invalidate,[true]);}.bind(this));},onSelect:function(E){var s=E.getSource().getSelectedKey();if(s==="calendar"||s==="list"){this._toggleCalendarModel(s==="calendar");}},onEntitlementPanelExpand:function(E){this._toggleEntitlements(E.getParameter("expand"));},onOverviewPanelExpand:function(E){this._toggleOverview(E.getParameter("expand"));},onMultiLeaveConfirm:function(E){var p=E.getParameter("selectedItem").getBindingContext("multiLeave").getProperty("sLeavePath");this.getRouter().navTo("display",{leavePath:p});},_toggleCalendarModel:function(s){this._oOverviewModel.setProperty("/showCalendar",s);this._oOverviewModel.setProperty("/viewSelection",s?"calendar":"list");this.oStorage.put(this.CALENDARPERSKEY,s);if(s){jQuery.sap.delayedCall(0,this,this.onCalendarStartDateChange);}},_onRouteMatched:function(E){this.oODataModel.metadataLoaded().then(function(){var A=this.getOwnerComponent().getAssignmentPromise();A.then(function(s){this._initOverviewModelBinding(s);}.bind(this));this.oErrorHandler.setShowErrors("immediately");this.oErrorHandler.clearErrors();}.bind(this));},_initOverviewModelBinding:function(E){if(this._sEmployeeNumber!==E){this._sEmployeeNumber=E;this._readEntitlements(E);this._readLeaveRequestWithDefaultStartDate(E);}},_readEntitlements:function(E){this._oEntitlementColumListItemTemplate=this._oEntitlementColumListItemTemplate?this._oEntitlementColumListItemTemplate.clone():this.getView().byId("entitlementColumnListItem");this.getView().byId("entitlementTable").bindItems({path:"/TimeAccountSet",groupId:"entitlements",template:this._oEntitlementColumListItemTemplate,filters:this._getActiveBaseFiltersForTimeAccount(this._oOverviewModel.getProperty("/entitlementStartDate"),E)});},_readLeaveRequestWithDefaultStartDate:function(m){this._bindLeaveRequestList(this.getModel("global").getProperty("/defaultFilterDate"),m);},_bindLeaveRequestList:function(s,m){this._oOverviewModel.setProperty("/isLeaveLoading",true);var E=m===undefined?this.getModel("global").getProperty("/sEmployeeNumber"):m;this._oOverviewModel.setProperty("/leaveRequestStartDate",s);this._oDataUtil=D.getInstance(E,this.oODataModel);this._oDataUtil.getCalendarEvents(u.dateToLocal(s)).then(function(r){this._oOverviewModel.setProperty("/leaveRequestTableItems",r.leaveRequests);this._oOverviewModel.setProperty("/isLeaveLoading",false);}.bind(this));if(this._oOverviewModel.getProperty("/showCalendar")){this.onCalendarStartDateChange();}},_getActiveBaseFiltersForTimeAccount:function(s,m){return[new F("FilterStartDate",c.GE,u.dateToUTC(s)),new F("EmployeeID",c.EQ,m)];},_refreshAbsences:function(){var s=this._oOverviewModel.getProperty("/leaveRequestStartDate");this._bindLeaveRequestList(s);},_refreshEntitlements:function(){var E=this.getView().byId("entitlementTable").getBinding("items");E.refresh();},_deleteRequest:function(I){this._oOverviewModel.setProperty("/isDeletingLeaveRequest",true);var L=I.getBindingContext("overview").getObject(),s=this.getModel().createKey("/LeaveRequestSet",L);this.oODataModel.remove(s,{success:function(){this._oOverviewModel.setProperty("/isDeletingLeaveRequest",false);this.getModel("global").setProperty("/lastLeaveRequestChangeDate",new Date());i.show(this.getResourceBundle().getText("deletedSuccessfully"));this._oDataUtil.refresh();this._refreshEntitlements();this._refreshAbsences();}.bind(this),error:function(E){this._oOverviewModel.setProperty("/isDeletingLeaveRequest",false);}.bind(this)});},_toggleEntitlements:function(E){this.oStorage.put(this.ENTITLEMENTSPERSKEY,E);this._oOverviewModel.setProperty("/entitlementsExpanded",E);},_toggleOverview:function(E){this.oStorage.put(this.OVERVIEWPERSKEY,E);this._oOverviewModel.setProperty("/overviewExpanded",E);}});});
