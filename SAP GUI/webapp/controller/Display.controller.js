/*
 * Copyright (C) 2009-2021 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["hcm/fab/myleaverequest/utils/utils","hcm/fab/myleaverequest/utils/formatters","hcm/fab/myleaverequest/controller/BaseController","sap/ui/core/routing/History","sap/ui/model/json/JSONModel","sap/ui/core/format/DateFormat","sap/m/Label","sap/m/Text","sap/m/LabelDesign","sap/m/MessageBox","sap/m/MessageToast","sap/m/MessagePopover","sap/m/MessagePopoverItem"],function(u,f,B,H,J,D,L,T,a,M,b,c,d){"use strict";return B.extend("hcm.fab.myleaverequest.controller.Display",{_oMessagePopover:null,formatter:f,utils:u,onInit:function(){this.oErrorHandler=this.getOwnerComponent().getErrorHandler();this._oNotesModel=new J({NoteCollection:[]});this.setModel(this._oNotesModel,"noteModel");this._oDisplayViewModel=new J({busy:true,isDataLoading:true,isTeamCalendarVisible:false,aAttachments:[]});this.setModel(this._oDisplayViewModel,"display");this._bIsBookmarkNavigation=false;this.getRouter().getRoute("display").attachPatternMatched(this._onDisplayMatched,this);var s=this.byId("status");if(s&&s.getMetadata().hasProperty("inverted")){s.setInverted(true);}var C=this.getView().byId("teamCalendar");if(C&&C.getMetadata().hasProperty("dataChangedDate")){C.bindProperty("dataChangedDate",{path:"/lastLeaveRequestChangeDate",model:"global",mode:"OneWay"});}},onExit:function(){this.oErrorHandler.clearErrors();},onEditRequest:function(e){u.navTo.call(this,"edit",{leavePath:e.getSource().getBindingContext().getPath().substr(1)});},onDeleteRequest:function(e){var C=this.getOwnerComponent(),o=e.getSource().getBindingContext(),s=o.getPath(),l=o.getProperty(s),i=false;if(this.getModel("global").getProperty("/bEditRequestBeforeDeletion")){if(l.hasOwnProperty("ReqOrInfty")){i=l.ReqOrInfty==='A'||l.ReqOrInfty==='P';}else{i=l.StatusID==="POSTED"||l.ChangeStateID===0;}}if(i){this.getRouter().navTo("delete",{leavePath:s.substr(1)});}else{M.confirm(this.getResourceBundle().getText("confirmDeleteMessage"),{styleClass:C.getContentDensityClass(),initialFocus:M.Action.CANCEL,onClose:function(A){if(A===M.Action.OK){this._deleteRequest(s);}}.bind(this)});}},onHandlePopover:function(e){var m=e.getSource(),v=this.getView();if(!this._oMessagePopover){this._oMessagePopover=new c({items:{path:"message>/",template:new d({description:"{message>description}",type:"{message>type}",title:"{message>message}",subtitle:"{message>additionalText}"})}});jQuery.sap.syncStyleClass(this.getOwnerComponent().getContentDensityClass(),v,this._oMessagePopover);v.addDependent(this._oMessagePopover);}this._oMessagePopover.toggle(m);},onNavBack:function(){this.oErrorHandler.clearErrors();var p=H.getInstance().getPreviousHash(),C=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");setTimeout(function(){this._oDisplayViewModel.setProperty("/isTeamCalendarVisible",false);this.getView().setBindingContext(null);}.bind(this),200);if(this._bIsBookmarkNavigation){this._bIsBookmarkNavigation=false;u.navTo.call(this,"overview",false);}else if(p!==undefined||(C&&!C.isInitialNavigation())){if(C){C.historyBack();}else{window.history.go(-1);}}else{C.toExternal({target:{shellHash:C.hrefForExternal({target:{shellHash:"#"}})}});}},_onDisplayMatched:function(e){this.oErrorHandler.clearErrors();var p=e.getParameter("arguments");this.getModel().metadataLoaded().then(function(){var A=this.getOwnerComponent().getAssignmentPromise();A.then(function(E){var o=p.leavePath;this._bindView("/"+o);}.bind(this));}.bind(this));},_bindView:function(l){var o=this.getView(),e=o.getModel().getProperty(l);if(!e||e.hasOwnProperty("ReqOrInfty")){if(!e){this._bIsBookmarkNavigation=true;}this._oDisplayViewModel.setProperty("/busy",true);this._oDisplayViewModel.setProperty("/isDataLoading",true);this.oErrorHandler.setShowErrors("manual");o.bindElement({path:l,events:{change:function(E){if(!o.getElementBinding().getBoundContext()){setTimeout(function(){this.oErrorHandler.displayErrorPopup(function(){u.navTo.call(this,"overview");this._oDisplayViewModel.setProperty("/isDataLoading",false);this._oDisplayViewModel.setProperty("/busy",false);this.oErrorHandler.setShowErrors("immediately");}.bind(this));}.bind(this),0);}var g=o.getBindingContext().getObject();if(g){this._handleDisplayLeave(g);}}.bind(this)}});}else{var C=new sap.ui.model.Context(o.getModel(),l);o.setBindingContext(C);this._handleDisplayLeave(C.getProperty(l));}},_handleDisplayLeave:function(l){var n=l.Notes,N=this.formatter.formatNotes(n);this._oNotesModel.setProperty("/NoteCollection",N);var A=Array.apply(null,{length:5}).map(function(U,i){return l["Attachment"+(i+1)];}).filter(function(o){return o.FileName!=="";});this._oDisplayViewModel.setProperty("/aAttachments",A);this._oDisplayViewModel.setProperty("/isDataLoading",false);this._oDisplayViewModel.setProperty("/busy",false);this.oErrorHandler.setShowErrors("immediately");this._oDisplayViewModel.setProperty("/isTeamCalendarVisible",true);},_deleteRequest:function(s){this._oDisplayViewModel.setProperty("/busy",true);this.getView().getModel().remove(s,{success:function(){this._oDisplayViewModel.setProperty("/busy",false);u.navTo.call(this,"overview");this.getOwnerComponent().getEventBus().publish("hcm.fab.myleaverequest","invalidateoverview",{fnAfterNavigate:function(){jQuery.sap.delayedCall(400,this,function(){b.show(this.getResourceBundle().getText("deletedSuccessfully"));});}.bind(this)});}.bind(this),error:function(e){this._oDisplayViewModel.setProperty("/busy",false);}.bind(this)});}});});
